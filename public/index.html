<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsApp Web - Sess√£o</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg,#4facfe,#00f2fe);
    color:#333;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    min-height:100vh;
    padding:20px;
  }
  h1 {
    color:#fff;
    margin-bottom:20px;
    text-shadow:2px 2px 8px rgba(0,0,0,0.2);
  }
  .input-group {
    display:flex;
    margin-bottom:20px;
  }
  input#sessionName {
    padding:12px;
    font-size:16px;
    border-radius:8px 0 0 8px;
    border:none;
    width:250px;
    max-width:70vw;
  }
  button {
    padding:12px 20px;
    font-size:16px;
    border-radius:0 8px 8px 0;
    border:none;
    background:#ffb347;
    color:#fff;
    cursor:pointer;
    transition:background 0.3s;
  }
  button:hover { background:#ffcc33; }
  #status {
    margin-top:10px;
    font-size:18px;
    font-weight:bold;
    color:#fff;
    text-shadow:1px 1px 4px rgba(0,0,0,0.3);
  }
  #qrContainer {
    margin-top:20px;
    background:#fff;
    padding:15px;
    border-radius:16px;
    display:none;
    flex-direction:column;
    align-items:center;
    box-shadow:0 8px 16px rgba(0,0,0,0.2);
  }
  #qrContainer canvas {
    width:100%;
    max-width:250px; /* QR menor e responsivo */
    border-radius:12px;
    margin-bottom:10px;
  }
  #qrAttempts {
    font-weight:bold;
    margin-top:5px;
  }
  #sessionData {
    margin-top:15px;
    background:rgba(255,255,255,0.95);
    padding:12px;
    border-radius:12px;
    max-width:600px;
    width:100%;
    text-align:left;
    box-shadow:0 6px 12px rgba(0,0,0,0.2);
    word-break: break-word;
    font-size:14px;
  }
  #logs {
    margin-top:20px;
    width:100%;
    max-width:600px;
    background:rgba(255,255,255,0.95);
    border-radius:12px;
    padding:15px;
    max-height:350px;
    overflow-y:auto;
    font-size:14px;
    line-height:1.4;
    box-shadow:0 6px 12px rgba(0,0,0,0.2);
  }
  .log-line { margin-bottom:5px; }
  @media(max-width:500px) {
    input#sessionName { width:60vw; }
    #qrContainer canvas { max-width:200px; }
  }
</style>
</head>
<body>

<h1>WhatsApp Web - Sess√£o</h1>

<div class="input-group">
  <input type="text" id="sessionName" placeholder="Digite o nome da sess√£o">
  <button id="startBtn">Iniciar Sess√£o</button>
</div>

<div id="status">Aguardando a√ß√£o...</div>

<div id="qrContainer">
  <canvas id="qrCanvas"></canvas>
  <div id="qrAttempts"></div>
</div>

<div id="sessionData"></div>

<div id="logs"></div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const socket = io();

const startBtn = document.getElementById('startBtn');
const sessionNameInput = document.getElementById('sessionName');
const logsDiv = document.getElementById('logs');
const statusDiv = document.getElementById('status');
const qrContainer = document.getElementById('qrContainer');
const qrCanvas = document.getElementById('qrCanvas');
const qrAttemptsDiv = document.getElementById('qrAttempts');
const sessionDataDiv = document.getElementById('sessionData');

function addLog(msg){
    const p=document.createElement('p');
    p.textContent=msg;
    p.className='log-line';
    logsDiv.appendChild(p);
    logsDiv.scrollTop=logsDiv.scrollHeight;
}

startBtn.addEventListener('click',()=>{
    const name=sessionNameInput.value.trim();
    if(!name)return alert('Digite o nome da sess√£o!');
    statusDiv.textContent=`Iniciando sess√£o: ${name}...`;
    addLog(`üîß Solicitando cria√ß√£o da sess√£o "${name}"...`);
    socket.emit('start-session',name);
});

// Logs
socket.on('log',(msg)=>{
    addLog(msg);
    statusDiv.textContent=msg;
});

// QR raw gerado instantaneamente
socket.on('qr',(data)=>{
    qrContainer.style.display='flex';
    qrAttemptsDiv.textContent=`Tentativa: ${data.attempt}/10`;
    QRCode.toCanvas(qrCanvas, data.qr, { width: 250 }, function (error) {
        if(error) addLog(`‚ùå Erro ao renderizar QR: ${error}`);
        else addLog(`[${data.session}] QR code exibido instantaneamente`);
    });
});

// Dados da sess√£o conectada
socket.on('session-data',(data)=>{
    qrContainer.style.display='none';
    sessionDataDiv.innerHTML=`
        <strong>üìå Sess√£o Ativa: ${data.session}</strong><br>
        Status: ${data.status}<br>
        Pushname: ${data.info?.pushname || 'N/A'}<br>
        Me: ${data.info?.me || 'N/A'}<br>
        Wid: ${data.info?.wid || 'N/A'}<br>
        <strong>Tokens:</strong> <pre>${JSON.stringify(data.tokens, null, 2)}</pre>
    `;
    addLog(`[${data.session}] Sess√£o conectada com sucesso!`);
});

// Sess√£o encerrada
socket.on('session-ended',(data)=>{
    addLog(`‚ùå Sess√£o "${data.session}" finalizada: ${data.reason}`);
    sessionDataDiv.innerHTML=`<strong>‚ùå Sess√£o ${data.session} encerrada</strong>`;
    qrContainer.style.display='none';
});
</script>

</body>
</html>
